name: Refresh Token
on:
  schedule:
    # Run every 8 minutes to compensate for GitHub Actions cron delays/skips.
    # Token expires after 30 min — frequent runs ensure refresh happens in time.
    - cron: "*/10 * * * *"
  workflow_dispatch:

concurrency:
  group: token-operations
  cancel-in-progress: false

env:
  TZ: Asia/Jerusalem

jobs:
  refresh-token:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Create temporary config from secrets
        run: |
          cat > config.json << 'EOF'
          {
            "AccessToken": "${{ secrets.ACCESS_TOKEN }}",
            "RefreshToken": "${{ secrets.REFRESH_TOKEN }}",
            "Amount": "${{ secrets.AMOUNT }}",
            "MoneycardId": "${{ secrets.MONEYCARD_ID }}"
          }
          EOF

      - name: Run token refresh and set outputs
        id: refresh
        shell: bash
        env:
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
          AMOUNT: ${{ secrets.AMOUNT }}
          MONEYCARD_ID: ${{ secrets.MONEYCARD_ID }}
        run: |
          set -euo pipefail
          out="$(node github-refresh-token.js 2>&1 || true)"
          echo "Script output: $out"

          if [ -z "$out" ] || ! jq -e . <<<"$out" >/dev/null 2>&1; then
            echo "No valid JSON output — skipping token update"
            echo "tokens_updated=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          tokens_updated=$(jq -r '.tokensUpdated // false' <<<"$out")
          access=$(jq -r '.accessToken // empty' <<<"$out")
          refresh=$(jq -r '.refreshToken // empty' <<<"$out")

          echo "tokens_updated=${tokens_updated}" >> "$GITHUB_OUTPUT"
          if [ -n "$access" ]; then
            echo "::add-mask::$access"
            echo "access_token=$access" >> "$GITHUB_OUTPUT"
          fi
          if [ -n "$refresh" ]; then
            echo "::add-mask::$refresh"
            echo "refresh_token=$refresh" >> "$GITHUB_OUTPUT"
          fi

      - name: Update ACCESS_TOKEN
        if: steps.refresh.outputs.tokens_updated == 'true' && steps.refresh.outputs.access_token != ''
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: gh secret set ACCESS_TOKEN --body "${{ steps.refresh.outputs.access_token }}"

      - name: Update REFRESH_TOKEN
        if: steps.refresh.outputs.tokens_updated == 'true' && steps.refresh.outputs.refresh_token != ''
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: gh secret set REFRESH_TOKEN --body "${{ steps.refresh.outputs.refresh_token }}"
