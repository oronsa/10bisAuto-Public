name: Load Credit

on:
#  schedule:
 #   - cron: "5 7 * * 0,1,2,3,4"  # Weekdays at 7:05 AM UTC
  workflow_dispatch:

concurrency:
  group: token-operations
  cancel-in-progress: false

env:
  TZ: Asia/Jerusalem

jobs:
  load-credit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          
      - name: Install dependencies
        run: npm ci
        
      - name: Create temporary config from secrets
        run: |
          cat > config.json << EOF
          {
            "AccessToken": "${{ secrets.ACCESS_TOKEN }}",
            "RefreshToken": "${{ secrets.REFRESH_TOKEN }}",
            "Amount": "${{ secrets.AMOUNT }}",
            "MoneycardId": "${{ secrets.MONEYCARD_ID }}"
          }
          EOF
      
      - name: Run credit loading
        id: load-credit
        run: node github-load-credit.js
        env:
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
          AMOUNT: ${{ secrets.AMOUNT }}
          MONEYCARD_ID: ${{ secrets.MONEYCARD_ID }}
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.run_number }}
          path: logs/
          retention-days: 30
